stages:
  - test
  - deploy

include:
- template: Security/SAST.gitlab-ci.yml

# SAST Security Scanning (override from template if needed)
# The template already defines sast job with stage: test

# Deploy to VPS (only on main branch)
deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    # Install SSH client
    - apk add --no-cache openssh-client
    # Setup SSH
    - mkdir -p ~/.ssh
    # Support both RSA and ED25519 keys
    - echo "$VPS_SSH_PRIVATE_KEY" > ~/.ssh/id_key
    - chmod 600 ~/.ssh/id_key
    - ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts
    # Verify SSH connection with verbose output for debugging
    - ssh -v -o StrictHostKeyChecking=no -i ~/.ssh/id_key $VPS_USER@$VPS_HOST "echo 'SSH connection successful'" || echo "‚ö†Ô∏è SSH connection failed, check key and VPS setup"
  script:
    - |
      echo "üöÄ Starting deployment to VPS..."
      
      # Set deploy path (default to /apps/g1-se1961-nj-swp391-fal25 if not set)
      DEPLOY_PATH=${VPS_DEPLOY_PATH:-/apps/g1-se1961-nj-swp391-fal25}
      
      # SSH into VPS and execute deployment commands
      ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_key $VPS_USER@$VPS_HOST "DEPLOY_PATH='$DEPLOY_PATH' bash -s" << 'ENDSSH'
        set -e  # Exit on error
        
        echo "üìÇ Changing to project directory: $DEPLOY_PATH"
        cd "$DEPLOY_PATH" || { echo "‚ùå Directory not found: $DEPLOY_PATH"; exit 1; }
        
        echo "üì• Pulling latest code from GitLab..."
        git fetch origin
        git reset --hard origin/main
        git clean -fd
        
        echo "üõë Stopping existing containers..."
        docker compose --profile production down || echo "‚ö†Ô∏è No containers to stop"
        
        echo "üî® Building Docker images..."
        docker compose --profile production build --no-cache
        
        echo "üöÄ Starting containers..."
        docker compose --profile production up -d
        
        echo "‚è≥ Waiting for services to be healthy..."
        sleep 10
        
        echo "üìä Checking container status..."
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        
        echo "‚úÖ Deployment completed successfully!"
      ENDSSH
      
      echo "üéâ Deployment finished!"
  after_script:
    # Cleanup SSH key
    - rm -f ~/.ssh/id_key
  only:
    - main
  when: on_success
  environment:
    name: production
    url: https://medconnects.app
